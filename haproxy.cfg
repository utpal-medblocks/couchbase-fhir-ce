#####################################################################
# Minimal HAProxy config for beta (frontend + backend only)
#
# Routes:
#   / or any non /api /fhir path -> frontend service (fhir-admin)
#   /api/* and /fhir/*            -> backend service (fhir-server)
#
# If the backend expects its resources without the leading /api or /fhir
# uncomment the "http-request replace-path" line inside backend-fhir-server.
#
# Exposes stats at /haproxy?stats (user: admin pass: admin)
#####################################################################

global
    log stdout format raw daemon
    # Runtime socket disabled for now (was causing Permission denied). Re-enable later if needed.
    # stats socket /tmp/haproxy/haproxy.sock mode 600 level admin

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option dontlog-normal  # Don't log successful requests (2xx/3xx) globally
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 5s

# Internal stats listener for backend container (no HTTPS redirect)
# Not exposed externally, only accessible within Docker network
listen stats-internal
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats auth admin:admin
    stats show-legends

frontend http-in
    bind *:80
    # Listen on HTTPS port if available
    # bind *:443 ssl crt /etc/haproxy/certs/example.pem
    # http-request redirect scheme https unless { ssl_fc }
    # End
    option forwardfor
    option http-server-close
    option dontlognull     # Don't log null connections

    # Stats UI and API
    stats uri /haproxy?stats
    stats refresh 5s
    stats auth admin:admin
    stats show-legends

    # ACLs to detect API / FHIR traffic and health checks
    # Order matters: Check .well-known FIRST (before /fhir catches it)
    acl is_wellknown path_beg /.well-known
    acl is_wellknown_in_fhir path_sub /.well-known
    acl is_api path_beg /api /fhir
    acl is_health path_beg /health
    acl is_oauth path_beg /oauth2
    acl is_login path_reg ^/login$
    acl is_consent path_reg ^/consent$
    
    # Route .well-known first (including /fhir/.well-known)
    use_backend backend-fhir-server if is_wellknown
    use_backend backend-fhir-server if is_wellknown_in_fhir
    use_backend backend-fhir-server if is_oauth
    use_backend backend-fhir-server if is_login
    use_backend backend-fhir-server if is_consent
    use_backend backend-fhir-server if is_api
    use_backend backend-fhir-server if is_health
    default_backend backend-fhir-admin
    
backend backend-fhir-admin
    balance roundrobin
    option httpchk HEAD /
    server frontend fhir-admin:80 check

backend backend-fhir-server
    balance roundrobin
    # Set X-Forwarded-Proto headers
    http-request set-header X-Forwarded-Proto http
    # Set X-Forwarded-Proto to https if the request is HTTPS
    # http-request set-header X-Forwarded-Proto https if { ssl_fc }

    # If backend should NOT receive the /api or /fhir prefix, enable one of:
    # http-request replace-path ^/(api|fhir)(/)?(.*)$ /\3
    # Otherwise leave commented and backend sees /api/... or /fhir/...

    # Health check configuration with circuit breaker integration
    # /health/readiness returns 200 when DB is up, 503 when DB is down
    # This allows HAProxy to automatically remove failed instances from the pool
    option httpchk GET /health/readiness
    http-check expect status 200
    
    # Health check timing:
    # - inter 5s: Check every 5 seconds
    # - fall 3: Mark down after 3 consecutive failures (15 seconds)
    # - rise 2: Mark up after 2 consecutive successes (10 seconds)
    server backend fhir-server:8080 check inter 5s fall 3 rise 2

# End of file
