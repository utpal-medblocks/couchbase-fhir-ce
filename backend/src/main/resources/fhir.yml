# FHIR Bucket Configuration
# This file defines the structure for converting a Couchbase bucket to FHIR-enabled
# Including scopes, collections, and indexes for each collection

fhir:
  scopes:
    admin:
      name: "Admin"
      description: "Administrative and metadata collections for FHIR server"
      collections:
        - name: "config"
          description: "Tenant configuration, feature flags"
          indexes:
            - name: "PRIMARY"
              type: "primary"
              sql: "CREATE PRIMARY INDEX ON `{bucket}`.`Admin`.`config` WITH {'defer_build': true}"

        - name: "users"
          description: "User management, authentication"
          indexes:
            - name: "PRIMARY"
              type: "primary"
              sql: "CREATE PRIMARY INDEX ON `{bucket}`.`Admin`.`users` WITH {'defer_build': true}"

    resources:
      name: "Resources"
      description: "FHIR clinical and administrative resource collections"
      collections:
        - name: "Patient"
          description: "Patient - 1 resource"
          indexes:

        - name: "Observation"
          description: "Observation - 1 resource"
          indexes:

        - name: "Encounter"
          description: "Encounter - 1 resource"
          indexes:

        - name: "Condition"
          description: "Condition - 1 resource"
          indexes:

        - name: "Procedure"
          description: "Procedure - 1 resource"
          indexes:

        - name: "MedicationRequest"
          description: "MedicationRequest - 1 resource"
          indexes:

        - name: "DiagnosticReport"
          description: "DiagnosticReport - 1 resource"
          indexes:

        - name: "DocumentReference"
          description: "DocumentReference - 1 resource"
          indexes:

        - name: "Immunization"
          description: "Immunization - 1 resource"
          indexes:

        - name: "ServiceRequest"
          description: "ServiceRequest - 1 resource"
          indexes:

        - name: "General"
          description: "All other resources"
          indexes:

        - name: "Versions"
          description: "FHIR Versions resources"
          indexes:

        - name: "Tombstones"
          description: "FHIR Tombstones resources"
          indexes:

  build_commands:
    - name: "Build Deferred Indexes"
      description: "Finds all deferred indexes and generates BUILD INDEX statements to run."
      query: |
        SELECT RAW CONCAT("BUILD INDEX ON ", k ,  "(['", CONCAT2 ("','", inames), "']);")
        FROM system:indexes AS s
        LET bid = CONCAT("`",s.bucket_id, "`"),
            sid = CONCAT("`", s.scope_id, "`"),
            kid = CONCAT("`", s.keyspace_id, "`"),
            k = NVL2(bid, CONCAT2(".", bid, sid, kid), kid)
        WHERE s.namespace_id = "default"
        GROUP BY k
        LETTING inames = ARRAY_AGG(s.name) FILTER (WHERE s.state = 'deferred')
        HAVING ARRAY_LENGTH(inames) > 0

# FHIR Resource to Collection Mapping Configuration
mapping:
  resource_to_collection:
    # Dedicated collections for high-volume/important resources
    Patient: Patient
    Observation: Observation
    Encounter: Encounter
    Condition: Condition
    Procedure: Procedure
    MedicationRequest: MedicationRequest
    DiagnosticReport: DiagnosticReport
    DocumentReference: DocumentReference
    Immunization: Immunization
    ServiceRequest: ServiceRequest

    # Default fallback - any resource not explicitly listed above goes to General collection
    _default: General

  # ResourceTypes that go into the General collection
  general:
    resource_types: "Account,ActivityDefinition,AdverseEvent,AllergyIntolerance,Appointment,AppointmentResponse,AuditEvent,Basic,Binary,BiologicallyDerivedProduct,BodyStructure,Bundle,CapabilityStatement,CarePlan,CareTeam,CatalogEntry,ChargeItem,ChargeItemDefinition,Claim,ClaimResponse,ClinicalImpression,CodeSystem,Communication,CommunicationRequest,CompartmentDefinition,Composition,ConceptMap,Consent,Contract,Coverage,CoverageEligibilityRequest,CoverageEligibilityResponse,DetectedIssue,Device,DeviceDefinition,DeviceMetric,DeviceRequest,DeviceUseStatement,DiagnosticReport,DocumentManifest,EffectEvidenceSynthesis,Endpoint,EnrollmentRequest,EnrollmentResponse,EpisodeOfCare,EventDefinition,Evidence,EvidenceVariable,ExampleScenario,ExplanationOfBenefit,FamilyMemberHistory,Flag,Goal,GraphDefinition,Group,GuidanceResponse,HealthcareService,ImagingStudy,ImplementationGuide,InsurancePlan,Invoice,Library,Linkage,List,Location,Measure,MeasureReport,Media,Medication,MedicationAdministration,MedicationDispense,MedicationKnowledge,MedicationStatement,MedicinalProduct,MedicinalProductAuthorization,MedicinalProductContraindication,MedicinalProductIndication,MedicinalProductIngredient,MedicinalProductInteraction,MedicinalProductManufactured,MedicinalProductPackaged,MedicinalProductPharmaceutical,MedicinalProductUndesirableEffect,MessageDefinition,MessageHeader,MolecularSequence,NamingSystem,NutritionOrder,OperationDefinition,OperationOutcome,Organization,OrganizationAffiliation,Parameters,PaymentNotice,PaymentReconciliation,Person,PlanDefinition,Practitioner,PractitionerRole,Provenance,Questionnaire,QuestionnaireResponse,RelatedPerson,RequestGroup,ResearchDefinition,ResearchElementDefinition,ResearchStudy,ResearchSubject,RiskAssessment,RiskEvidenceSynthesis,Schedule,SearchParameter,Slot,Specimen,SpecimenDefinition,StructureDefinition,StructureMap,Subscription,Substance,SubstanceNucleicAcid,SubstancePolymer,SubstanceProtein,SubstanceReferenceInformation,SubstanceSourceMaterial,SubstanceSpecification,SupplyDelivery,SupplyRequest,Task,TerminologyCapabilities,TestReport,TestScript,ValueSet,VerificationResult,VisionPrescription"

  collection_to_fts_index:
    Patient: ftsPatient
    Observation: ftsObservation
    Encounter: ftsEncounter
    Condition: ftsCondition
    Procedure: ftsProcedure
    MedicationRequest: ftsMedicationRequest
    DiagnosticReport: ftsDiagnosticReport
    DocumentReference: ftsDocumentReference
    Immunization: ftsImmunization
    ServiceRequest: ftsServiceRequest
    General: ftsGeneral
    Versions: ftsVersions
