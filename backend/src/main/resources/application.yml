spring:
  application:
    name: backend
  config:
    import: classpath:fhir.yml

# OAuth2 Authorization Server Configuration
# Default value for local development
# Production deployments should set this in config.yaml (takes precedence at runtime)
app:
  baseUrl: ${APP_BASE_URL:http://localhost:8080/fhir}

# CORS Configuration (can be overridden via environment variables)
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:*}
  allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS}
  allowed-headers: ${CORS_ALLOWED_HEADERS:*}

# OAuth Token Expiry Configuration
# Set OAUTH_TOKEN_EXPIRY_HOURS environment variable to change token validity
# Default: 24 hours (development/testing)
# Production recommendation: 1 hour
# Examples:
#   - 24 hour stress test: export OAUTH_TOKEN_EXPIRY_HOURS=25
#   - Production: export OAUTH_TOKEN_EXPIRY_HOURS=1
#   - Week-long testing: export OAUTH_TOKEN_EXPIRY_HOURS=168

# HTTP Compression (applies to all responses including fastpath JSON)
server:
  compression:
    enabled: true
    mime-types: application/json,application/fhir+json,text/html,text/xml,text/plain,application/xml
    min-response-size: 1024 # Compress responses > 1KB
  # Session cookie configuration for OAuth cross-site flows
  servlet:
    session:
      cookie:
        same-site: none # Required for cross-site OAuth (Inferno -> cbfhir.com)
        secure: true # Required when same-site=none (HTTPS)

# Basic Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,mappings,beans
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      show-components: always

# Container-specific configuration
---
spring:
  config:
    activate:
      on-profile: prod

# Suppress error details and stack traces in production/container environments
server:
  error:
    include-stacktrace: never
    include-message: on-param
    include-binding-errors: never
    include-exception: false
  compression:
    enabled: true
    mime-types: application/json,application/fhir+json,text/html,text/xml,text/plain,application/xml
    min-response-size: 1024 # Compress responses > 1KB
  tomcat:
    accesslog:
      enabled: false
    threads:
      max: ${SERVER_TOMCAT_THREADS_MAX:50} # Override with env var (default 50 for low memory)
      min-spare: ${SERVER_TOMCAT_THREADS_MIN_SPARE:10} # Minimum idle threads
    accept-count: ${SERVER_TOMCAT_ACCEPT_COUNT:100} # Queue size when all threads busy
    max-connections: ${SERVER_TOMCAT_MAX_CONNECTIONS:200} # Max simultaneous connections
    connection-timeout: ${SERVER_TOMCAT_CONNECTION_TIMEOUT:20s}
    max-keep-alive-requests: ${SERVER_TOMCAT_MAX_KEEP_ALIVE_REQUESTS:1000}

# Logging configuration for containers
logging:
  level:
    "[ca.uhn.fhir.rest.server.RestfulServer]": OFF
    "[org.apache.catalina]": ERROR
    "[org.apache.catalina.connector]": OFF
    "[org.springframework.security]": ERROR
    "[org.springframework.security.oauth2]": ERROR
    "[org.springframework.web.servlet]": ERROR
    "[com.couchbase.transactions]": ERROR
  pattern:
    console: "%d{HH:mm:ss.SSS} %-5level %logger{20} - %msg%n"
